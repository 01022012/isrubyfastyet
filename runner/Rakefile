require 'tempfile'
require 'rubygems'
require 'fan'

begin
  require 'artii'
rescue LoadError
end

# turn the config file into an array of hashes
def rubies
  rows = File.read(File.join(File.dirname(__FILE__), 'rubies')).lines.map(&:chomp).select { |line| line !~ /^\s*#/ }.map { |line| line.split(/\s\s+/) }

  headers = rows.shift

  rows.map do |row|
    {}.tap do |hash|
      row.each_with_index do |cell, i|
        hash.merge!(headers[i] => cell)
      end
    end
  end
end

def run_with_output(command)
  note = "Running: #{command}"
  puts "=" * note.size
  puts note
  puts "=" * note.size

  Process.wait( fork { exec command } )
  $?.success? # return whether command succeeded or not
end

def relative_path(path)
  File.join(File.dirname(__FILE__), path)
end

def script_path(script)
  relative_path("scripts/#{script}")
end


task :default => :benchmark_suite

task :benchmark_suite do
  p rubies

  # get the fans going
  Fan.maximize_all!
  at_exit { Fan.return_all_to_normal! }

  benchmark_file_paths = Dir.glob(relative_path('benchmarks/*/*benchmark.rb'))
  benchmark_folder_paths = benchmark_file_paths.map { |path| File.dirname(path) }.uniq
  result_tempfile = Tempfile.new("benchmark_result")

  rubies.each do |ruby|

    if defined?(Artii)
      # pretty ascii art
      puts Artii::Base.new(ruby['Nice Name']).output
    else
      puts
      puts ruby['Nice Name'].chars.to_a.join(" ")
      puts
    end

    # update the Ruby
    # fail if install takes longer than 45 minutes
    ruby_install_succeeded = run_with_output "#{script_path 'timeout3'} -t #{45*60} -i 30 -d 30 #{script_path 'setup_ruby'} #{ruby['RVM Name']}"

    # set up Gemfile.lock's
    if ruby_install_succeeded
      benchmark_folder_paths.each do |benchmark_folder_path|
        run_with_output "#{script_path 'setup_bundle'} #{benchmark_folder_path} #{ruby['RVM Name']}"
      end
    end

    # run benchmarks
    benchmark_file_paths.each do |benchmark_file_path|

      benchmark_file_path =~ /benchmarks\/([^\/]+)\/([^\/]*)benchmark\.rb/
      benchmark_suite_name = $1
      benchmark_script_name = ($2 == '' ? nil : $2.chop)
      benchmark_full_name = [benchmark_suite_name, benchmark_script_name].compact.join('_')

      if ruby_install_succeeded
        run_with_output "#{script_path 'run_benchmark'} #{File.dirname(benchmark_file_path)} #{ruby['RVM Name']} '#{ruby['Command']}' #{benchmark_file_path} #{result_tempfile.path}"

        result_tempfile.rewind
        result = result_tempfile.read.chomp

        full_version_string = `#{script_path 'ruby_version_in_rvm'} #{ruby['RVM Name']} #{ruby['Command']}`.lines.to_a.last.strip
      else
        result = "failed to install #{ruby['RVM Name']}"
        full_version_string = result
      end

      File.open(relative_path("../results/#{benchmark_full_name}_results.tsv"), 'a') do |results_file|
        results_file.puts [Time.now.utc.strftime("%F %T UTC"), ruby['RVM Name'], result, full_version_string].join("\t")
      end
      
      puts result
    end
  end
end